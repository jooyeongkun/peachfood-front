<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Th√¥ng tin giao h√†ng</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #f5f5f5;
      padding: 20px;
    }

    .container {
      max-width: 600px;
      margin: 0 auto;
      background: white;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      overflow: hidden;
    }


    .content {
      padding: 20px;
    }

    .section {
      margin-bottom: 25px;
    }

    .section-title {
      font-size: 16px;
      font-weight: bold;
      color: #333;
      margin-bottom: 12px;
    }

    .info-row {
      display: flex;
      padding: 10px 0;
      border-bottom: 1px solid #f0f0f0;
    }

    .info-row:last-child {
      border-bottom: none;
    }

    .info-label {
      width: 80px;
      color: #666;
      font-size: 14px;
    }

    .info-value {
      flex: 1;
      color: #333;
      font-size: 14px;
      font-weight: 500;
    }

    .phone-button {
      display: block;
      width: calc(100% - 40px);
      margin: 20px 20px;
      padding: 16px;
      background: #00D9A5;
      color: white;
      text-align: center;
      text-decoration: none;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.3s;
    }

    .phone-button:hover {
      background: #00C896;
    }

    .items {
      background: #f9f9f9;
      padding: 15px;
      border-radius: 8px;
    }

    .item {
      display: flex;
      justify-content: space-between;
      padding: 8px 0;
    }

    .item-name {
      color: #333;
      font-size: 14px;
    }

    .item-quantity {
      color: #666;
      font-size: 14px;
    }

    .total {
      font-size: 18px;
      font-weight: bold;
      color: #00D9A5;
      text-align: right;
      margin-top: 15px;
      padding-top: 15px;
      border-top: 2px solid #e0e0e0;
    }

    .buttons {
      padding: 20px;
      background: #f9f9f9;
    }

    .btn {
      width: 100%;
      padding: 16px;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      margin-bottom: 12px;
      transition: all 0.3s;
    }

    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .btn-pickup {
      background: #FFB74D;
      color: white;
    }

    .btn-pickup:hover:not(:disabled) {
      background: #FFA726;
    }

    .btn-arrived {
      background: #64B5F6;
      color: white;
    }

    .btn-arrived:hover:not(:disabled) {
      background: #42A5F5;
    }

    .btn-complete {
      background: #81C784;
      color: white;
    }

    .btn-complete:hover:not(:disabled) {
      background: #66BB6A;
    }

    .status {
      text-align: center;
      padding: 15px;
      background: #e3f2fd;
      color: #1976d2;
      font-weight: 600;
      border-radius: 8px;
      margin-bottom: 15px;
    }

    .loading {
      text-align: center;
      padding: 40px;
      color: #666;
    }

    .error {
      text-align: center;
      padding: 40px;
      color: #f44336;
    }
  </style>
</head>
<body>
  <div class="container">
    <div id="loading" class="loading">
      ƒêang t·∫£i...
    </div>

    <div id="error" class="error" style="display: none;">
      Kh√¥ng th·ªÉ t·∫£i th√¥ng tin ƒë∆°n h√†ng.
    </div>

    <div id="orderContent" style="display: none;">
      <div class="content">
        <!-- Th√¥ng tin giao h√†ng -->
        <div class="section">
          <div class="section-title">
            Th√¥ng tin giao h√†ng
          </div>
          <div class="info-row">
            <div class="info-label">M√£ ƒë∆°n</div>
            <div class="info-value" id="orderNumber">-</div>
          </div>
          <div class="info-row">
            <div class="info-label">ƒê·ªãa ch·ªâ</div>
            <div class="info-value" id="customerAddress">-</div>
          </div>
        </div>

        <!-- N√∫t g·ªçi ƒëi·ªán -->
        <a id="phoneButton" class="phone-button">
          üìû G·ªçi cho kh√°ch h√†ng
        </a>

        <!-- Chi ti·∫øt ƒë∆°n h√†ng -->
        <div class="section">
          <div class="section-title">
            Chi ti·∫øt ƒë∆°n h√†ng
          </div>
          <div class="items" id="orderItems">
            <!-- ÎèôÏ†ÅÏúºÎ°ú ÏÉùÏÑ± -->
          </div>
          <div class="total" id="totalAmount">-</div>
        </div>
      </div>

      <!-- Î≤ÑÌäº ÏòÅÏó≠ -->
      <div class="buttons">
        <button id="btnAction" class="btn" onclick="handleAction()">
          <!-- ÎèôÏ†ÅÏúºÎ°ú Î≥ÄÍ≤Ω -->
        </button>
      </div>
    </div>
  </div>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

  <script>
    // Firebase ÏÑ§Ï†ï
    const firebaseConfig = {
      apiKey: "AIzaSyCvN2LZaoF8etMQVeGFcvTKNL05AQO4Aj4",
      authDomain: "pushalaram-3d13e.firebaseapp.com",
      projectId: "pushalaram-3d13e",
      storageBucket: "pushalaram-3d13e.firebasestorage.app",
      messagingSenderId: "380990311069",
      appId: "1:380990311069:android:48b5e0f7414227191f2274"
    };

    // Firebase Ï¥àÍ∏∞Ìôî
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // URLÏóêÏÑú ÌÜ†ÌÅ∞ Í∞ÄÏ†∏Ïò§Í∏∞
    const urlParams = new URLSearchParams(window.location.search);
    const token = window.location.pathname.split('/').pop() || urlParams.get('token');

    let orderData = null;

    // Ï£ºÎ¨∏ Ï†ïÎ≥¥ Î°úÎìú Î∞è Ïã§ÏãúÍ∞Ñ Î¶¨Ïä§ÎÑà ÏÑ§Ï†ï
    async function loadOrder() {
      if (!token) {
        showError();
        return;
      }

      try {
        // Ïã§ÏãúÍ∞Ñ Î¶¨Ïä§ÎÑà ÏÑ§Ï†ï
        db.collection('orders').doc(token).onSnapshot(
          (doc) => {
            if (doc.exists) {
              orderData = doc.data();
              displayOrder(orderData);
            } else {
              showError();
            }
          },
          (error) => {
            console.error('Error loading order:', error);
            showError();
          }
        );
      } catch (error) {
        console.error('Error setting up listener:', error);
        showError();
      }
    }

    // Ï£ºÎ¨∏ Ï†ïÎ≥¥ ÌëúÏãú
    function displayOrder(data) {
      document.getElementById('loading').style.display = 'none';
      document.getElementById('orderContent').style.display = 'block';

      document.getElementById('orderNumber').textContent = data.orderNumber;
      document.getElementById('customerAddress').textContent = data.customerAddress;

      const phoneButton = document.getElementById('phoneButton');
      phoneButton.href = `tel:${data.customerPhone}`;

      // Ï£ºÎ¨∏ Ìï≠Î™© ÌëúÏãú
      const itemsHtml = data.items.map(item => `
        <div class="item">
          <span class="item-name">${item.name}</span>
          <span class="item-quantity">x${item.quantity}</span>
        </div>
      `).join('');
      document.getElementById('orderItems').innerHTML = itemsHtml;

      document.getElementById('totalAmount').textContent =
        `T·ªïng c·ªông: ${(data.totalAmount || data.totalPrice || 0).toLocaleString()}ƒë`;

      // ÏÉÅÌÉúÏóê Îî∞Î•∏ Î≤ÑÌäº ÌôúÏÑ±Ìôî
      updateButtons(data.status);
    }

    // ÌòÑÏû¨ ÏÉÅÌÉúÎ•º Ï†ÄÏû•
    let currentOrderStatus = null;

    // Î≤ÑÌäº ÏÉÅÌÉú ÏóÖÎç∞Ïù¥Ìä∏
    function updateButtons(status) {
      currentOrderStatus = status;
      const btnAction = document.getElementById('btnAction');

      // new (ƒë∆°n m·ªõi) -> n√∫t x√°c nh·∫≠n ƒë∆°n
      if (status === 'new') {
        btnAction.textContent = '‚úÖ X√°c nh·∫≠n ƒë∆°n';
        btnAction.className = 'btn btn-pickup';
        btnAction.disabled = false;
      }
      // confirmed (ƒë√£ x√°c nh·∫≠n) -> n√∫t b·∫Øt ƒë·∫ßu giao h√†ng
      else if (status === 'confirmed') {
        btnAction.textContent = 'üöö B·∫Øt ƒë·∫ßu giao';
        btnAction.className = 'btn btn-pickup';
        btnAction.disabled = false;
      }
      // picked_up (ƒëang giao) -> n√∫t ƒë√£ ƒë·∫øn n∆°i
      else if (status === 'picked_up') {
        btnAction.textContent = 'üìç ƒê√£ ƒë·∫øn n∆°i';
        btnAction.className = 'btn btn-arrived';
        btnAction.disabled = false;
      }
      // arrived (ƒë√£ ƒë·∫øn) -> n√∫t ho√†n th√†nh
      else if (status === 'arrived') {
        btnAction.textContent = '‚úÖ Ho√†n th√†nh';
        btnAction.className = 'btn btn-complete';
        btnAction.disabled = false;
      }
      // delivered (ƒë√£ ho√†n th√†nh) -> v√¥ hi·ªáu h√≥a n√∫t
      else if (status === 'delivered') {
        btnAction.textContent = '‚úÖ ƒê√£ ho√†n th√†nh';
        btnAction.className = 'btn btn-complete';
        btnAction.disabled = true;
      }
    }

    // Î≤ÑÌäº ÌÅ¥Î¶≠ Ìï∏Îì§Îü¨
    function handleAction() {
      let nextStatus = null;

      if (currentOrderStatus === 'new') {
        nextStatus = 'confirmed';
      } else if (currentOrderStatus === 'confirmed') {
        nextStatus = 'picked_up';
      } else if (currentOrderStatus === 'picked_up') {
        nextStatus = 'arrived';
      } else if (currentOrderStatus === 'arrived') {
        nextStatus = 'delivered';
      }

      if (nextStatus) {
        updateStatus(nextStatus);
      }
    }

    // ÏÉÅÌÉú ÏóÖÎç∞Ïù¥Ìä∏
    async function updateStatus(newStatus) {
      if (!token) return;

      try {
        await db.collection('orders').doc(token).update({
          status: newStatus,
          updatedBy: 'web',
          updatedAt: new Date().toISOString()
        });

        orderData.status = newStatus;
        updateButtons(newStatus);
      } catch (error) {
        console.error('Error updating status:', error);
        alert('C·∫≠p nh·∫≠t tr·∫°ng th√°i th·∫•t b·∫°i.');
      }
    }

    // ÏóêÎü¨ ÌëúÏãú
    function showError() {
      document.getElementById('loading').style.display = 'none';
      document.getElementById('error').style.display = 'block';
    }

    // ÌéòÏù¥ÏßÄ Î°úÎìú Ïãú Ï£ºÎ¨∏ Ï†ïÎ≥¥ Í∞ÄÏ†∏Ïò§Í∏∞
    loadOrder();
  </script>
</body>
</html>
